use crate::octree::V3c;
use crate::spatial::{
    math::{
        hash_direction, hash_region, octant_bitmask, position_in_bitmap_64bits,
        set_occupancy_in_bitmap_64bits,
    },
    offset_region,
};

#[allow(dead_code)]
fn convert_8bit_bitmap_to_64bit() {
    for octant in 0..8 {
        let min_pos = offset_region(octant);
        let min_pos = V3c::new(
            min_pos.x as usize * 2,
            min_pos.y as usize * 2,
            min_pos.z as usize * 2,
        );
        let mut result_bitmap = 0;
        for x in min_pos.x..(min_pos.x + 2) {
            for y in min_pos.y..(min_pos.y + 2) {
                for z in min_pos.z..(min_pos.z + 2) {
                    set_occupancy_in_bitmap_64bits(
                        &V3c::new(x, y, z),
                        1,
                        4,
                        true,
                        &mut result_bitmap,
                    );
                }
            }
        }
    }
}

#[allow(dead_code)]
fn generate_lut_64_bits() -> [[u64; 8]; 64] {
    // 64 poisitions, 8 directions
    let mut bitmap_lut = [[0u64; 8]; 64];

    //position
    for x in 0i32..4 {
        for y in 0i32..4 {
            for z in 0i32..4 {
                let bitmask_position =
                    position_in_bitmap_64bits(x as usize, y as usize, z as usize, 4);
                //direction
                for dx in -1i32..=1 {
                    for dy in -1i32..=1 {
                        for dz in -1i32..=1 {
                            // step through the brick in the given direction and set relevant bits to occupied
                            if 0 == dx || 0 == dy || 0 == dz {
                                continue;
                            }
                            let direction_position =
                                hash_direction(&V3c::new(dx as f32, dy as f32, dz as f32));
                            let moved_x = (x + dx * 4).clamp(0, 3);
                            let moved_y = (y + dy * 4).clamp(0, 3);
                            let moved_z = (z + dz * 4).clamp(0, 3);
                            let min_x = moved_x.min(x);
                            let max_x = moved_x.max(x);
                            let min_y = moved_y.min(y);
                            let max_y = moved_y.max(y);
                            let min_z = moved_z.min(z);
                            let max_z = moved_z.max(z);
                            let mut result_bitmask = 0;
                            for bx in min_x..=max_x {
                                for by in min_y..=max_y {
                                    for bz in min_z..=max_z {
                                        set_occupancy_in_bitmap_64bits(
                                            &V3c::new(bx as usize, by as usize, bz as usize),
                                            1,
                                            4,
                                            true,
                                            &mut result_bitmask,
                                        );
                                    }
                                }
                            }
                            bitmap_lut[bitmask_position][direction_position as usize] =
                                result_bitmask;
                        }
                    }
                }
            }
        }
    }
    bitmap_lut
}

#[allow(dead_code)]
fn generate_lut_8_bits() -> [[u8; 8]; 8] {
    // 8 poisitions, 8 directions
    let mut bitmap_lut = [[0u8; 8]; 8];

    //position
    for x in 0i32..2 {
        for y in 0i32..2 {
            for z in 0i32..2 {
                let bitmask_position = hash_region(&V3c::new(x as f32, y as f32, z as f32), 0.5);
                //direction
                for dx in -1i32..=1 {
                    for dy in -1i32..=1 {
                        for dz in -1i32..=1 {
                            // step through the brick in the given direction and set the positional bits to occupied
                            if 0 == dx || 0 == dy || 0 == dz {
                                continue;
                            }
                            let direction_position =
                                hash_direction(&V3c::new(dx as f32, dy as f32, dz as f32));
                            let moved_x = (x + dx * 2).clamp(0, 2);
                            let moved_y = (y + dy * 2).clamp(0, 2);
                            let moved_z = (z + dz * 2).clamp(0, 2);
                            let min_x = moved_x.min(x);
                            let max_x = moved_x.max(x);
                            let min_y = moved_y.min(y);
                            let max_y = moved_y.max(y);
                            let min_z = moved_z.min(z);
                            let max_z = moved_z.max(z);

                            let mut result_bitmask = 0;
                            for bx in min_x..=max_x {
                                for by in min_y..=max_y {
                                    for bz in min_z..=max_z {
                                        result_bitmask |= octant_bitmask(hash_region(
                                            &V3c::new(bx as f32, by as f32, bz as f32),
                                            0.5,
                                        ));
                                    }
                                }
                            }
                            bitmap_lut[bitmask_position as usize][direction_position as usize] =
                                result_bitmask;
                        }
                    }
                }
            }
        }
    }

    bitmap_lut
}

#[allow(dead_code)]
fn generate_octant_step_result_lut() -> [[[u32; 3]; 3]; 3] {
    let octant_after_step = |step_vector: &V3c<i32>, octant: u8| {
        const SPACE_SIZE: f32 = 12.;
        let octant_offset = offset_region(octant);
        let octant_center = (
            SPACE_SIZE / 4. + octant_offset.x * (SPACE_SIZE / 2.),
            SPACE_SIZE / 4. + octant_offset.y * (SPACE_SIZE / 2.),
            SPACE_SIZE / 4. + octant_offset.z * (SPACE_SIZE / 2.),
        );
        let step_signum = (
            step_vector.x.signum() as f32,
            step_vector.y.signum() as f32,
            step_vector.z.signum() as f32,
        );
        let center_after_step = V3c::new(
            octant_center.0 + step_signum.0 * (SPACE_SIZE / 2.),
            octant_center.1 + step_signum.1 * (SPACE_SIZE / 2.),
            octant_center.2 + step_signum.2 * (SPACE_SIZE / 2.),
        );

        if center_after_step.x < 0.
            || center_after_step.x > SPACE_SIZE
            || center_after_step.y < 0.
            || center_after_step.y > SPACE_SIZE
            || center_after_step.z < 0.
            || center_after_step.z > SPACE_SIZE
        {
            OOB_OCTANT
        } else {
            hash_region(&center_after_step, SPACE_SIZE / 2.)
        }
    };

    let mut lut = [[[0u32; 3]; 3]; 3];
    for octant in 0..8 {
        let octant_pos_in_32bits: u8 = 4 * octant;
        for z in -1i32..=1 {
            for y in -1i32..=1 {
                for x in -1i32..=1 {
                    let result_octant = octant_after_step(&V3c::new(x, y, z), octant);
                    lut[(x + 1) as usize][(y + 1) as usize][(z + 1) as usize] |=
                        (result_octant as u32 & 0x0F) << octant_pos_in_32bits;
                    let octant_in_lut = (lut[(x + 1) as usize][(y + 1) as usize][(z + 1) as usize]
                        & (0x0F << octant_pos_in_32bits))
                        >> octant_pos_in_32bits;
                    assert!(octant_in_lut == result_octant as u32);
                }
            }
        }
    }
    lut
}

#[allow(dead_code)]
fn generate_lvl1_bitmap_index_lut() -> [[[u8; 4]; 4]; 4] {
    let mut lut = [[[0u8; 4]; 4]; 4];
    for x in 0..4 {
        for y in 0..4 {
            for z in 0..4 {
                lut[x][y][z] = position_in_bitmap_64bits(x, y, z, 4) as u8;
            }
        }
    }
    lut
}

pub(crate) const OOB_OCTANT: u8 = 8;

pub(crate) const BITMAP_INDEX_LUT: [[[u8; 4]; 4]; 4] = [
    [
        [0, 16, 32, 48],
        [4, 20, 36, 52],
        [8, 24, 40, 56],
        [12, 28, 44, 60],
    ],
    [
        [1, 17, 33, 49],
        [5, 21, 37, 53],
        [9, 25, 41, 57],
        [13, 29, 45, 61],
    ],
    [
        [2, 18, 34, 50],
        [6, 22, 38, 54],
        [10, 26, 42, 58],
        [14, 30, 46, 62],
    ],
    [
        [3, 19, 35, 51],
        [7, 23, 39, 55],
        [11, 27, 43, 59],
        [15, 31, 47, 63],
    ],
];

pub(crate) const OCTANT_STEP_RESULT_LUT: [[[u32; 3]; 3]; 3] = [
    [
        [143165576, 671647880, 2284357768],
        [1216874632, 1749559304, 2288551976],
        [2290632840, 2290640968, 2290649192],
    ],
    [
        [277383304, 839944328, 2285013128],
        [1418203272, 1985229328, 2289469490],
        [2290635912, 2290644564, 2290649206],
    ],
    [
        [2173208712, 2206304392, 2290321544],
        [2240315784, 2273674113, 2290583683],
        [2290648456, 2290648965, 2290649223],
    ],
];

pub(crate) const RAY_TO_NODE_OCCUPANCY_BITMASK_LUT: [[u8; 8]; 8] = [
    [1, 3, 5, 15, 17, 51, 85, 255],
    [3, 2, 15, 10, 51, 34, 255, 170],
    [5, 15, 4, 12, 85, 255, 68, 204],
    [15, 10, 12, 8, 255, 170, 204, 136],
    [17, 51, 85, 255, 16, 48, 80, 240],
    [51, 34, 255, 170, 48, 32, 240, 160],
    [85, 255, 68, 204, 80, 240, 64, 192],
    [255, 170, 204, 136, 240, 160, 192, 128],
];

pub(crate) const RAY_TO_LEAF_OCCUPANCY_BITMASK_LUT: [[u64; 8]; 64] = [
    [
        1,
        15,
        281479271743489,
        4222189076152335,
        4369,
        65535,
        1229782938247303441,
        18446744073709551615,
    ],
    [
        3,
        14,
        844437815230467,
        3940709804408846,
        13107,
        61166,
        3689348814741910323,
        17216961135462248174,
    ],
    [
        7,
        12,
        1970354902204423,
        3377751260921868,
        30583,
        52428,
        8608480567731124087,
        14757395258967641292,
    ],
    [
        15,
        8,
        4222189076152335,
        2251834173947912,
        65535,
        34952,
        18446744073709551615,
        9838263505978427528,
    ],
    [
        17,
        255,
        4785147619639313,
        71777214294589695,
        4368,
        65520,
        1229501458975559952,
        18442521884633399280,
    ],
    [
        51,
        238,
        14355442858917939,
        66992066674950382,
        13104,
        61152,
        3688504376926679856,
        17213020425657839328,
    ],
    [
        119,
        204,
        33496033337475191,
        57421771435671756,
        30576,
        52416,
        8606510212828919664,
        14754017507706719424,
    ],
    [
        255,
        136,
        71777214294589695,
        38281180957114504,
        65520,
        34944,
        18442521884633399280,
        9836011671804479616,
    ],
    [
        273,
        4095,
        76843841185972497,
        1152657617789587455,
        4352,
        65280,
        1224997790627664128,
        18374966859414961920,
    ],
    [
        819,
        3822,
        230531523557917491,
        1075813776603614958,
        13056,
        60928,
        3674993371882992384,
        17149969068787297792,
    ],
    [
        1911,
        3276,
        537906888301807479,
        922126094231669964,
        30464,
        52224,
        8574984534393648896,
        14699973487531969536,
    ],
    [
        4095,
        2184,
        1152657617789587455,
        614750729487779976,
        65280,
        34816,
        18374966859414961920,
        9799982325021313024,
    ],
    [
        4369,
        65535,
        1229782938247303441,
        18446744073709551615,
        4096,
        61440,
        1152939097061330944,
        17294086455919964160,
    ],
    [
        13107,
        61166,
        3689348814741910323,
        17216961135462248174,
        12288,
        57344,
        3458817291183992832,
        16141147358858633216,
    ],
    [
        30583,
        52428,
        8608480567731124087,
        14757395258967641292,
        28672,
        49152,
        8070573679429316608,
        13835269164735971328,
    ],
    [
        65535,
        34952,
        18446744073709551615,
        9838263505978427528,
        61440,
        32768,
        17294086455919964160,
        9223512776490647552,
    ],
    [
        65537,
        983055,
        281479271743488,
        4222189076152320,
        286331153,
        4294967295,
        1229782938247299072,
        18446744073709486080,
    ],
    [
        196611,
        917518,
        844437815230464,
        3940709804408832,
        858993459,
        4008636142,
        3689348814741897216,
        17216961135462187008,
    ],
    [
        458759,
        786444,
        1970354902204416,
        3377751260921856,
        2004318071,
        3435973836,
        8608480567731093504,
        14757395258967588864,
    ],
    [
        983055,
        524296,
        4222189076152320,
        2251834173947904,
        4294967295,
        2290649224,
        18446744073709486080,
        9838263505978392576,
    ],
    [
        1114129,
        16711935,
        4785147619639296,
        71777214294589440,
        286265616,
        4293984240,
        1229501458975555584,
        18442521884633333760,
    ],
    [
        3342387,
        15597806,
        14355442858917888,
        66992066674950144,
        858796848,
        4007718624,
        3688504376926666752,
        17213020425657778176,
    ],
    [
        7798903,
        13369548,
        33496033337475072,
        57421771435671552,
        2003859312,
        3435187392,
        8606510212828889088,
        14754017507706667008,
    ],
    [
        16711935,
        8913032,
        71777214294589440,
        38281180957114368,
        4293984240,
        2290124928,
        18442521884633333760,
        9836011671804444672,
    ],
    [
        17891601,
        268374015,
        76843841185972224,
        1152657617789583360,
        285217024,
        4278255360,
        1224997790627659776,
        18374966859414896640,
    ],
    [
        53674803,
        250482414,
        230531523557916672,
        1075813776603611136,
        855651072,
        3993038336,
        3674993371882979328,
        17149969068787236864,
    ],
    [
        125241207,
        214699212,
        537906888301805568,
        922126094231666688,
        1996519168,
        3422604288,
        8574984534393618432,
        14699973487531917312,
    ],
    [
        268374015,
        143132808,
        1152657617789583360,
        614750729487777792,
        4278255360,
        2281736192,
        18374966859414896640,
        9799982325021278208,
    ],
    [
        286331153,
        4294967295,
        1229782938247299072,
        18446744073709486080,
        268439552,
        4026593280,
        1152939097061326848,
        17294086455919902720,
    ],
    [
        858993459,
        4008636142,
        3689348814741897216,
        17216961135462187008,
        805318656,
        3758153728,
        3458817291183980544,
        16141147358858575872,
    ],
    [
        2004318071,
        3435973836,
        8608480567731093504,
        14757395258967588864,
        1879076864,
        3221274624,
        8070573679429287936,
        13835269164735922176,
    ],
    [
        4294967295,
        2290649224,
        18446744073709486080,
        9838263505978392576,
        4026593280,
        2147516416,
        17294086455919902720,
        9223512776490614784,
    ],
    [
        4295032833,
        64425492495,
        281479271677952,
        4222189075169280,
        18764998447377,
        281474976710655,
        1229782937960972288,
        18446744069414584320,
    ],
    [
        12885098499,
        60130459662,
        844437815033856,
        3940709803491328,
        56294995342131,
        262709978263278,
        3689348813882916864,
        17216961131453612032,
    ],
    [
        30065229831,
        51540393996,
        1970354901745664,
        3377751260135424,
        131354989131639,
        225179981368524,
        8608480565726806016,
        14757395255531667456,
    ],
    [
        64425492495,
        34360262664,
        4222189075169280,
        2251834173423616,
        281474976710655,
        150119987579016,
        18446744069414584320,
        9838263503687778304,
    ],
    [
        73015558161,
        1095233372415,
        4785147618525184,
        71777214277877760,
        18760703414544,
        281410551218160,
        1229501458689294336,
        18442521880339415040,
    ],
    [
        219046674483,
        1022217814254,
        14355442855575552,
        66992066659352576,
        56282110243632,
        262649847803616,
        3688504376067883008,
        17213020421650120704,
    ],
    [
        511108907127,
        876186697932,
        33496033329676288,
        57421771422302208,
        131324923901808,
        225128440974528,
        8606510210825060352,
        14754017504271532032,
    ],
    [
        1095233372415,
        584124465288,
        71777214277877760,
        38281180948201472,
        281410551218160,
        150085627316352,
        18442521880339415040,
        9836011669514354688,
    ],
    [
        1172543963409,
        17588159451135,
        76843841168080896,
        1152657617521213440,
        18691982889216,
        280379743338240,
        1224997790342447104,
        18374966855136706560,
    ],
    [
        3517631890227,
        16415615487726,
        230531523504242688,
        1075813776353132544,
        56075948667648,
        261687760449024,
        3674993371027341312,
        17149969064794259456,
    ],
    [
        8207807743863,
        14070527560908,
        537906888176566272,
        922126094016970752,
        130843880224512,
        224303794670592,
        8574984532397129728,
        14699973484109365248,
    ],
    [
        17588159451135,
        9380351707272,
        1152657617521213440,
        614750729344647168,
        280379743338240,
        149535863113728,
        18374966855136706560,
        9799982322739576832,
    ],
    [
        18764998447377,
        281474976710655,
        1229782937960972288,
        18446744069414584320,
        17592454483968,
        263886817259520,
        1152939096792891392,
        17294086451893370880,
    ],
    [
        56294995342131,
        262709978263278,
        3689348813882916864,
        17216961131453612032,
        52777363451904,
        246294362775552,
        3458817290378674176,
        16141147355100479488,
    ],
    [
        131354989131639,
        225179981368524,
        8608480565726806016,
        14757395255531667456,
        123147181387776,
        211109453807616,
        8070573677550239744,
        13835269161514696704,
    ],
    [
        281474976710655,
        150119987579016,
        18446744069414584320,
        9838263503687778304,
        263886817259520,
        140739635871744,
        17294086451893370880,
        9223512774343131136,
    ],
    [
        281479271743489,
        4222189076152335,
        281474976710656,
        4222124650659840,
        1229782938247303441,
        18446744073709551615,
        1229764173248856064,
        18446462598732840960,
    ],
    [
        844437815230467,
        3940709804408846,
        844424930131968,
        3940649673949184,
        3689348814741910323,
        17216961135462248174,
        3689292519746568192,
        17216698425483984896,
    ],
    [
        1970354902204423,
        3377751260921868,
        1970324836974592,
        3377699720527872,
        8608480567731124087,
        14757395258967641292,
        8608349212741992448,
        14757170078986272768,
    ],
    [
        4222189076152335,
        2251834173947912,
        4222124650659840,
        2251799813685248,
        18446744073709551615,
        9838263505978427528,
        18446462598732840960,
        9838113385990848512,
    ],
    [
        4785147619639313,
        71777214294589695,
        4785074604081152,
        71776119061217280,
        1229501458975559952,
        18442521884633399280,
        1229482698272145408,
        18442240474082181120,
    ],
    [
        14355442858917939,
        66992066674950382,
        14355223812243456,
        66991044457136128,
        3688504376926679856,
        17213020425657839328,
        3688448094816436224,
        17212757775810035712,
    ],
    [
        33496033337475191,
        57421771435671756,
        33495522228568064,
        57420895248973824,
        8606510212828919664,
        14754017507706719424,
        8606378887905017856,
        14753792379265744896,
    ],
    [
        71777214294589695,
        38281180957114504,
        71776119061217280,
        38280596832649216,
        18442521884633399280,
        9836011671804479616,
        18442240474082181120,
        9835861586177163264,
    ],
    [
        76843841185972497,
        1152657617789587455,
        76842668642009088,
        1152640029630136320,
        1224997790627664128,
        18374966859414961920,
        1224979098644774912,
        18374686479671623680,
    ],
    [
        230531523557917491,
        1075813776603614958,
        230528005926027264,
        1075797360988127232,
        3674993371882992384,
        17149969068787297792,
        3674937295934324736,
        17149707381026848768,
    ],
    [
        537906888301807479,
        922126094231669964,
        537898680494063616,
        922112023704109056,
        8574984534393648896,
        14699973487531969536,
        8574853690513424384,
        14699749183737298944,
    ],
    [
        1152657617789587455,
        614750729487779976,
        1152640029630136320,
        614741349136072704,
        18374966859414961920,
        9799982325021313024,
        18374686479671623680,
        9799832789158199296,
    ],
    [
        1229782938247303441,
        18446744073709551615,
        1229764173248856064,
        18446462598732840960,
        1152939097061330944,
        17294086455919964160,
        1152921504606846976,
        17293822569102704640,
    ],
    [
        3689348814741910323,
        17216961135462248174,
        3689292519746568192,
        17216698425483984896,
        3458817291183992832,
        16141147358858633216,
        3458764513820540928,
        16140901064495857664,
    ],
    [
        8608480567731124087,
        14757395258967641292,
        8608349212741992448,
        14757170078986272768,
        8070573679429316608,
        13835269164735971328,
        8070450532247928832,
        13835058055282163712,
    ],
    [
        18446744073709551615,
        9838263505978427528,
        18446462598732840960,
        9838113385990848512,
        17294086455919964160,
        9223512776490647552,
        17293822569102704640,
        9223372036854775808,
    ],
];
